-- Policies for the order_items table
CREATE POLICY "Enable read access for authenticated users" ON order_items FOR SELECT TO authenticated USING (EXISTS (SELECT 1 FROM orders WHERE orders.id = order_items.order_id AND (EXISTS (SELECT 1 FROM restaurants WHERE restaurants.id = orders.restaurant_id AND restaurants.owner_id = auth.uid()) OR EXISTS (SELECT 1 FROM servers WHERE servers.id = orders.server_id AND servers.email = auth.email() AND servers.is_active = true))));
CREATE POLICY "Enable insert for authenticated users" ON order_items FOR INSERT TO authenticated WITH CHECK (EXISTS (SELECT 1 FROM orders WHERE orders.id = order_items.order_id AND (EXISTS (SELECT 1 FROM restaurants WHERE restaurants.id = orders.restaurant_id AND restaurants.owner_id = auth.uid()) OR EXISTS (SELECT 1 FROM servers WHERE servers.id = orders.server_id AND servers.email = auth.email() AND servers.is_active = true))));
CREATE POLICY "Enable update for servers and owners" ON order_items FOR UPDATE TO authenticated USING (EXISTS (SELECT 1 FROM orders WHERE orders.id = order_items.order_id AND (EXISTS (SELECT 1 FROM restaurants WHERE restaurants.id = orders.restaurant_id AND restaurants.owner_id = auth.uid()) OR EXISTS (SELECT 1 FROM servers WHERE servers.id = orders.server_id AND servers.email = auth.email() AND servers.is_active = true)))) WITH CHECK (EXISTS (SELECT 1 FROM orders WHERE orders.id = order_items.order_id AND (EXISTS (SELECT 1 FROM restaurants WHERE restaurants.id = orders.restaurant_id AND restaurants.owner_id = auth.uid()) OR EXISTS (SELECT 1 FROM servers WHERE servers.id = orders.server_id AND servers.email = auth.email() AND servers.is_active = true))));
CREATE POLICY "Enable delete for servers and owners" ON order_items FOR DELETE TO authenticated USING (EXISTS (SELECT 1 FROM orders WHERE orders.id = order_items.order_id AND (EXISTS (SELECT 1 FROM restaurants WHERE restaurants.id = orders.restaurant_id AND restaurants.owner_id = auth.uid()) OR EXISTS (SELECT 1 FROM servers WHERE servers.id = orders.server_id AND servers.email = auth.email() AND servers.is_active = true))));

-- ... existing policies ... 